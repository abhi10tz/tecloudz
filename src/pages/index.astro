---
import Layout from '../layouts/Layout.astro'; // Capitalized 'L' is safer
import { getCollection } from 'astro:content';
import { formatDate } from '../utils/date';

// 1. Fetch all posts
const allPosts = await getCollection('posts');

// 2. Sort by Date (Newest first)
const sortedPosts = allPosts.sort((a, b) => 
  b.data.date.valueOf() - a.data.date.valueOf()
);

// 3. Separate Featured vs. List
const featuredPost = sortedPosts.find(p => p.data.featured);
// Filter out the featured post from the main list
const listPosts = sortedPosts.filter(p => p.id !== featuredPost?.id);

// SEO Schema
const schemaData = {
  "@context": "https://schema.org",
  "@type": "NewsMediaOrganization",
  "name": "tecloudz",
  "url": Astro.site,
  "blogPost": sortedPosts.map(post => ({
    "@type": "BlogPosting",
    "headline": post.data.title,
    "datePublished": post.data.date.toISOString(),
    "author": { "@type": "Person", "name": post.data.author }
  }))
};
---

<Layout title="tecloudz | Tech stories that matter" activeNav="home">
  
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

  <main>
    {featuredPost &&
      <section class="hero" aria-label="Featured Story">
        <span class="meta-label">Featured Story &mdash; {formatDate(featuredPost.data.date)}</span>
        <article>
          <h1><a href={`/posts/${featuredPost.id}`}>{featuredPost.data.title}</a></h1>
          <p class="lead">{featuredPost.data.description}</p>
          <div class="author-meta">By {featuredPost.data.author} in <strong>{featuredPost.data.category}</strong></div>
        </article>
      </section>
    }

    <hr class="divider" />

    <section class="feed" aria-label="Latest News">
      <div class="feed-header"><h2>Latest</h2></div>
      
      <div class="article-list">
        {listPosts.map((post) => (
          <article class="feed-item">
            <div class="item-meta">
              <time datetime={post.data.date.toISOString()}>{formatDate(post.data.date)}</time>
              <span class="cat-tag">/ {post.data.category}</span>
            </div>
            <h3><a href={`/posts/${post.id}`}>{post.data.title}</a></h3>
          </article>
        ))}
      </div>
    </section>
  </main>

  </Layout>

<style>
  /* --- UPDATED STYLES --- */
  
  h1 { font-size: 2.5rem; letter-spacing: -0.03em; line-height: 1.1; margin: 0.5rem 0 1rem 0; font-weight: 800; }
  
  h2 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin: 0; }
  
  h3 { font-size: 1.25rem; font-weight: 600; margin: 0; letter-spacing: -0.01em; }
  
  p { color: var(--text-main); }
  .lead { font-size: 1.2rem; color: var(--text-muted); margin-bottom: 1.5rem; }
  
  .hero { margin-bottom: 3rem; }
  .meta-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .author-meta { font-size: 0.9rem; color: var(--text-muted); }
  
  .divider { border: 0; border-top: 1px solid var(--border-color); margin: 3rem 0; }
  
  .feed-header { margin-bottom: 2rem; }
  .article-list { display: flex; flex-direction: column; gap: 2.5rem; }
  
  .feed-item { display: flex; flex-direction: column; gap: 0.25rem; transition: opacity 0.2s; }
  .feed-item:hover { opacity: 0.7; }
  
  .item-meta { font-size: 0.85rem; color: var(--text-muted); font-family: monospace; margin-bottom: 0.25rem; }

  @media (max-width: 600px) { h1 { font-size: 2rem; } }
</style>